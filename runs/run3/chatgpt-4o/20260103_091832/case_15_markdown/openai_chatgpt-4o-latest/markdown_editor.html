<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Editor</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    body.dark {
      background-color: #1e1e1e;
      color: #ddd;
    }

    #editor, #preview {
      width: 50%;
      height: 100%;
      padding: 1em;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #editor {
      background-color: #f5f5f5;
      border-right: 1px solid #ccc;
    }

    body.dark #editor {
      background-color: #2e2e2e;
      color: #ddd;
      border-color: #444;
    }

    #preview {
      background-color: white;
    }

    body.dark #preview {
      background-color: #121212;
      color: #ddd;
    }

    textarea {
      width: 100%;
      height: 100%;
      border: none;
      resize: none;
      background: transparent;
      color: inherit;
      font-size: 1em;
      font-family: monospace;
    }

    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #eee;
      padding: 0.5em;
      box-sizing: border-box;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    body.dark #toolbar {
      background: #333;
      color: #ddd;
    }

    #container {
      display: flex;
      width: 100%;
      height: calc(100vh - 2.5em);
      margin-top: 2.5em;
    }

    button {
      margin-left: 0.5em;
    }

    a {
      color: #1a0dab;
    }

    body.dark a {
      color: #8ab4f8;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div>
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button onclick="exportHTML()">Export as HTML</button>
    </div>
    <div>
      <button onclick="saveToLocal()">Save</button>
      <button onclick="loadFromLocal()">Load</button>
    </div>
  </div>
  <div id="container">
    <div id="editor">
      <textarea id="markdown" placeholder="Enter markdown here..."></textarea>
    </div>
    <div id="preview"></div>
  </div>

  <script>
    const textarea = document.getElementById('markdown');
    const preview = document.getElementById('preview');

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function parseMarkdown(md) {
      const lines = md.split('\n');
      let html = '';
      let inCodeBlock = false;

      for (let line of lines) {
        if (line.startsWith('```')) {
          inCodeBlock = !inCodeBlock;
          html += inCodeBlock ? '<pre><code>' : '</code></pre>';
          continue;
        }

        if (inCodeBlock) {
          html += escapeHTML(line) + '\n';
          continue;
        }

        if (line.startsWith('# ')) {
          html += `<h1>${line.slice(2)}</h1>`;
        } else if (line.startsWith('## ')) {
          html += `<h2>${line.slice(3)}</h2>`;
        } else if (line.startsWith('### ')) {
          html += `<h3>${line.slice(4)}</h3>`;
        } else if (line.match(/^>\s+/)) {
          html += `<blockquote>${line.replace(/^>\s+/, '')}</blockquote>`;
        } else if (line.match(/^\d+\.\s+/)) {
          if (!html.endsWith('<ol>')) html += '<ol>';
          html += `<li>${line.replace(/^\d+\.\s+/, '')}</li>`;
        } else if (line.startsWith('- ')) {
          if (!html.endsWith('<ul>')) html += '<ul>';
          html += `<li>${line.slice(2)}</li>`;
        } else if (line.trim() === '') {
          if (html.endsWith('</li>')) {
            html += html.includes('<ul>') ? '</ul>' : '</ol>';
          }
        } else {
          // inline formatting
          let formatted = line
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
          html += `<p>${formatted}</p>`;
        }
      }

      // Close unclosed lists
      if (html.includes('<ul>') && !html.includes('</ul>')) html += '</ul>';
      if (html.includes('<ol>') && !html.includes('</ol>')) html += '</ol>';

      return html;
    }

    function updatePreview() {
      const md = textarea.value;
      preview.innerHTML = parseMarkdown(md);
    }

    textarea.addEventListener('input', updatePreview);

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

    function exportHTML() {
      const htmlContent = `
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Exported Markdown</title></head>
<body>
${preview.innerHTML}
</body>
</html>`;
      const blob = new Blob([htmlContent], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'export.html';
      a.click();
    }

    function saveToLocal() {
      localStorage.setItem('markdownContent', textarea.value);
      alert('Saved to localStorage');
    }

    function loadFromLocal() {
      const content = localStorage.getItem('markdownContent');
      if (content !== null) {
        textarea.value = content;
        updatePreview();
      } else {
        alert('No saved content found.');
      }
    }

    // Initial load
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    loadFromLocal();
    updatePreview();
  </script>
</body>
</html>