<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Log Analytics Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .chart { margin-bottom: 40px; }
        svg { border: 1px solid #ccc; background: #f9f9f9; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #eee; }
        input { margin: 5px 0; padding: 5px; }
    </style>
</head>
<body>
    <h1>Log Analytics Dashboard</h1>

    <div class="chart">
        <h2>Log Level Percentages</h2>
        <svg id="levelChart" width="400" height="200"></svg>
    </div>

    <div class="chart">
        <h2>Errors Over Time</h2>
        <svg id="errorTimeline" width="800" height="200"></svg>
    </div>

    <div class="chart">
        <h2>Top 5 Error Messages</h2>
        <ul id="topErrors"></ul>
    </div>

    <div class="chart">
        <h2>CRITICAL Errors</h2>
        <label for="search">Search:</label>
        <input type="text" id="search" placeholder="Search messages...">
        <table>
            <thead>
                <tr><th>Timestamp</th><th>Message</th></tr>
            </thead>
            <tbody id="criticalTable"></tbody>
        </table>
    </div>

    <script>
        async function fetchData() {
            const res = await fetch('/data');
            return await res.json();
        }

        function drawBarChart(svgId, data) {
            const svg = document.getElementById(svgId);
            const width = svg.getAttribute("width");
            const height = svg.getAttribute("height");
            const ctx = svg.getContext ? svg.getContext("2d") : null;
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            const keys = Object.keys(data);
            const values = Object.values(data);
            const max = Math.max(...values);
            const barWidth = width / keys.length;

            keys.forEach((key, i) => {
                const barHeight = (values[i] / max) * (height - 20);
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", i * barWidth + 10);
                rect.setAttribute("y", height - barHeight - 20);
                rect.setAttribute("width", barWidth - 20);
                rect.setAttribute("height", barHeight);
                rect.setAttribute("fill", "#69c");
                svg.appendChild(rect);

                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute("x", i * barWidth + barWidth / 2);
                label.setAttribute("y", height - 5);
                label.setAttribute("font-size", "10");
                label.setAttribute("text-anchor", "middle");
                label.textContent = key;
                svg.appendChild(label);
            });
        }

        function drawLineChart(svgId, data) {
            const svg = document.getElementById(svgId);
            const width = svg.getAttribute("width");
            const height = svg.getAttribute("height");
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            const keys = Object.keys(data).sort();
            const values = keys.map(k => data[k]);
            const max = Math.max(...values);
            const padding = 40;
            const stepX = (width - 2 * padding) / (keys.length - 1);

            const points = values.map((v, i) => {
                const x = padding + stepX * i;
                const y = height - padding - (v / max) * (height - 2 * padding);
                return { x, y };
            });

            const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            polyline.setAttribute("fill", "none");
            polyline.setAttribute("stroke", "#c33");
            polyline.setAttribute("stroke-width", "2");
            polyline.setAttribute("points", points.map(p => `${p.x},${p.y}`).join(" "));
            svg.appendChild(polyline);

            points.forEach((p, i) => {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", p.x);
                circle.setAttribute("cy", p.y);
                circle.setAttribute("r", 3);
                circle.setAttribute("fill", "#c33");
                svg.appendChild(circle);

                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute("x", p.x);
                label.setAttribute("y", height - 5);
                label.setAttribute("font-size", "10");
                label.setAttribute("text-anchor", "middle");
                label.textContent = keys[i].slice(11, 16); // show HH:MM
                svg.appendChild(label);
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById("criticalTable");
            const search = document.getElementById("search").value.toLowerCase();
            tbody.innerHTML = "";
            data.forEach(row => {
                if (row.message.toLowerCase().includes(search)) {
                    const tr = document.createElement("tr");
                    const td1 = document.createElement("td");
                    const td2 = document.createElement("td");
                    td1.textContent = row.timestamp;
                    td2.textContent = row.message;
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tbody.appendChild(tr);
                }
            });
        }

        function populateTopErrors(list) {
            const ul = document.getElementById("topErrors");
            ul.innerHTML = "";
            list.forEach(item => {
                const li = document.createElement("li");
                li.textContent = `${item[0]} (${item[1]} times)`;
                ul.appendChild(li);
            });
        }

        async function init() {
            const data = await fetchData();
            drawBarChart("levelChart", data.level_percentages);
            drawLineChart("errorTimeline", data.errors_per_hour);
            populateTopErrors(data.top_errors);
            updateTable(data.critical_errors);

            document.getElementById("search").addEventListener("input", () => {
                updateTable(data.critical_errors);
            });
        }

        init();
    </script>
</body>
</html>