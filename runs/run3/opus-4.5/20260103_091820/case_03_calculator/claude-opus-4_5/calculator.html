<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .calculator {
            background: linear-gradient(145deg, #2d2d44, #1a1a2e);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .display {
            background: linear-gradient(135deg, #0a0a12, #1a1a2e);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 20px;
            text-align: right;
            box-shadow: 
                inset 0 4px 10px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.05);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .expression {
            color: #6b7280;
            font-size: 16px;
            min-height: 24px;
            word-wrap: break-word;
            margin-bottom: 8px;
        }

        .result {
            color: #ffffff;
            font-size: 42px;
            font-weight: 300;
            letter-spacing: -1px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        button {
            border: none;
            border-radius: 16px;
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            padding: 0;
            height: 70px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            transition: opacity 0.15s ease;
            opacity: 0;
        }

        button:hover::before {
            opacity: 1;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-number {
            background: linear-gradient(145deg, #3d3d5c, #2a2a40);
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-number::before {
            background: linear-gradient(145deg, #4a4a6a, #3d3d5c);
        }

        .btn-number:active {
            background: linear-gradient(145deg, #2a2a40, #3d3d5c);
        }

        .btn-operator {
            background: linear-gradient(145deg, #e94560, #c73e54);
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(233, 69, 96, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-operator::before {
            background: linear-gradient(145deg, #ff5a75, #e94560);
        }

        .btn-operator:active {
            background: linear-gradient(145deg, #c73e54, #e94560);
        }

        .btn-clear {
            background: linear-gradient(145deg, #6366f1, #4f46e5);
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-clear::before {
            background: linear-gradient(145deg, #818cf8, #6366f1);
        }

        .btn-clear:active {
            background: linear-gradient(145deg, #4f46e5, #6366f1);
        }

        .btn-equals {
            background: linear-gradient(145deg, #10b981, #059669);
            color: #ffffff;
            grid-column: span 2;
            box-shadow: 
                0 4px 15px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-equals::before {
            background: linear-gradient(145deg, #34d399, #10b981);
        }

        .btn-equals:active {
            background: linear-gradient(145deg, #059669, #10b981);
        }

        .btn-zero {
            grid-column: span 2;
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .keyboard-hint {
            text-align: center;
            color: #4b5563;
            font-size: 12px;
            margin-top: 16px;
        }

        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .flash {
            animation: flash 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display">
            <div class="expression" id="expression"></div>
            <div class="result" id="result">0</div>
        </div>
        <div class="buttons">
            <button class="btn-clear" onclick="clearAll()"><span>C</span></button>
            <button class="btn-operator" onclick="appendOperator('/')"><span>÷</span></button>
            <button class="btn-operator" onclick="appendOperator('*')"><span>×</span></button>
            <button class="btn-operator" onclick="deleteLast()"><span>⌫</span></button>
            
            <button class="btn-number" onclick="appendNumber('7')"><span>7</span></button>
            <button class="btn-number" onclick="appendNumber('8')"><span>8</span></button>
            <button class="btn-number" onclick="appendNumber('9')"><span>9</span></button>
            <button class="btn-operator" onclick="appendOperator('-')"><span>−</span></button>
            
            <button class="btn-number" onclick="appendNumber('4')"><span>4</span></button>
            <button class="btn-number" onclick="appendNumber('5')"><span>5</span></button>
            <button class="btn-number" onclick="appendNumber('6')"><span>6</span></button>
            <button class="btn-operator" onclick="appendOperator('+')"><span>+</span></button>
            
            <button class="btn-number" onclick="appendNumber('1')"><span>1</span></button>
            <button class="btn-number" onclick="appendNumber('2')"><span>2</span></button>
            <button class="btn-number" onclick="appendNumber('3')"><span>3</span></button>
            <button class="btn-equals" onclick="calculate()"><span>=</span></button>
            
            <button class="btn-number btn-zero" onclick="appendNumber('0')"><span>0</span></button>
            <button class="btn-number" onclick="appendDecimal()"><span>.</span></button>
        </div>
        <div class="keyboard-hint">Use keyboard for input</div>
    </div>

    <script>
        let currentInput = '0';
        let expression = '';
        let shouldResetInput = false;
        let lastResult = null;

        const resultDisplay = document.getElementById('result');
        const expressionDisplay = document.getElementById('expression');

        function updateDisplay() {
            resultDisplay.textContent = formatNumber(currentInput);
            expressionDisplay.textContent = formatExpression(expression);
        }

        function formatNumber(num) {
            if (num === 'Error' || num === 'Infinity' || num === '-Infinity') {
                return num === 'Infinity' || num === '-Infinity' ? '∞' : num;
            }
            
            const parts = num.toString().split('.');
            let intPart = parts[0];
            const decPart = parts[1];
            
            // Don't format if it's being typed (has trailing operators or is in progress)
            if (num.includes('e') || num.includes('E')) {
                return num;
            }
            
            // Format integer part with commas
            if (intPart.length > 3 && !intPart.includes('-')) {
                intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else if (intPart.length > 4 && intPart.includes('-')) {
                intPart = intPart.charAt(0) + intPart.slice(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            return decPart !== undefined ? `${intPart}.${decPart}` : intPart;
        }

        function formatExpression(expr) {
            return expr
                .replace(/\*/g, ' × ')
                .replace(/\//g, ' ÷ ')
                .replace(/\+/g, ' + ')
                .replace(/-/g, ' − ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function appendNumber(num) {
            if (shouldResetInput) {
                currentInput = num;
                shouldResetInput = false;
            } else if (currentInput === '0' && num !== '0') {
                currentInput = num;
            } else if (currentInput === '0' && num === '0') {
                // Don't add multiple leading zeros
            } else if (currentInput.replace(/[^0-9]/g, '').length < 15) {
                currentInput += num;
            }
            updateDisplay();
        }

        function appendDecimal() {
            if (shouldResetInput) {
                currentInput = '0.';
                shouldResetInput = false;
            } else if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateDisplay();
        }

        function appendOperator(op) {
            if (currentInput === 'Error') {
                return;
            }

            if (expression && shouldResetInput) {
                // Replace the last operator
                expression = expression.slice(0, -1) + op;
            } else {
                expression += currentInput + op;
                shouldResetInput = true;
            }
            updateDisplay();
        }

        function clearAll() {
            currentInput = '0';
            expression = '';
            shouldResetInput = false;
            lastResult = null;
            updateDisplay();
        }

        function deleteLast() {
            if (currentInput === 'Error') {
                clearAll();
                return;
            }

            if (shouldResetInput) {
                // Remove last operator from expression
                if (expression.length > 0) {
                    expression = expression.slice(0, -1);
                    // Find the last number in the expression
                    const matches = expression.match(/[\d.]+$/);
                    if (matches) {
                        currentInput = matches[0];
                        expression = expression.slice(0, -matches[0].length);
                    } else {
                        currentInput = '0';
                    }
                    shouldResetInput = false;
                }
            } else {
                if (currentInput.length > 1) {
                    currentInput = currentInput.slice(0, -1);
                } else {
                    currentInput = '0';
                }
            }
            updateDisplay();
        }

        function calculate() {
            if (currentInput === 'Error') {
                return;
            }

            let fullExpression = expression + currentInput;
            
            if (!fullExpression || fullExpression === '0') {
                return;
            }

            try {
                // Check for division by zero
                if (/\/\s*0(?![0-9.])/.test(fullExpression) || /\/\s*0$/.test(fullExpression)) {
                    const parts = fullExpression.split('/');
                    for (let i = 1; i < parts.length; i++) {
                        const num = parseFloat(parts[i]);
                        if (num === 0) {
                            expressionDisplay.textContent = formatExpression(fullExpression) + ' =';
                            currentInput = 'Error';
                            resultDisplay.textContent = 'Cannot divide by zero';
                            expression = '';
                            shouldResetInput = true;
                            return;
                        }
                    }
                }

                // Evaluate the expression
                let result = Function('"use strict"; return (' + fullExpression + ')')();
                
                // Handle special cases
                if (!isFinite(result)) {
                    expressionDisplay.textContent = formatExpression(fullExpression) + ' =';
                    currentInput = 'Error';
                    resultDisplay.textContent = result === Infinity ? '∞' : result === -Infinity ? '-∞' : 'Error';
                    expression = '';
                    shouldResetInput = true;
                    return;
                }

                // Round to avoid floating point issues
                result = Math.round(result * 1000000000000) / 1000000000000;
                
                // Convert to string and handle very long decimals
                let resultStr = result.toString();
                if (resultStr.length > 15) {
                    result = parseFloat(result.toPrecision(10));
                    resultStr = result.toString();
                }

                expressionDisplay.textContent = formatExpression(fullExpression) + ' =';
                currentInput = resultStr;
                expression = '';
                shouldResetInput = true;
                lastResult = result;
                resultDisplay.textContent = formatNumber(resultStr);

            } catch (e) {
                expressionDisplay.textContent = formatExpression(fullExpression) + ' =';
                currentInput = 'Error';
                resultDisplay.textContent = 'Error';
                expression = '';
                shouldResetInput = true;
            }
        }

        // Keyboard support
        document.addEventListener('keydown', function(e) {
            const key = e.key;
            
            // Find and flash the corresponding button
            let buttonToFlash = null;
            
            if (/^[0-9]$/.test(key)) {
                appendNumber(key);
                buttonToFlash = [...document.querySelectorAll('.btn-number')].find(
                    btn => btn.textContent === key
                );
            } else if (key === '.') {
                appendDecimal();
                buttonToFlash = [...document.querySelectorAll('.btn-number')].find(
                    btn => btn.textContent === '.'
                );
            } else if (key === '+') {
                appendOperator('+');
                buttonToFlash = [...document.querySelectorAll('.btn-operator')].find(
                    btn => btn.textContent === '+'
                );
            } else if (key === '-') {
                appendOperator('-');
                buttonToFlash = [...document.querySelectorAll('.btn-operator')].find(
                    btn => btn.textContent === '−'
                );
            } else if (key === '*' || key === 'x' || key === 'X') {
                appendOperator('*');
                buttonToFlash = [...document.querySelectorAll('.btn-operator')].find(
                    btn => btn.textContent === '×'
                );
            } else if (key === '/') {
                e.preventDefault();
                appendOperator('/');
                buttonToFlash = [...document.querySelectorAll('.btn-operator')].find(
                    btn => btn.textContent === '÷'
                );
            } else if (key === 'Enter' || key === '=') {
                e.preventDefault();
                calculate();
                buttonToFlash = document.querySelector('.btn-equals');
            } else if (key === 'Escape' || key === 'c' || key === 'C') {
                clearAll();
                buttonToFlash = document.querySelector('.btn-clear');
            } else if (key === 'Backspace') {
                deleteLast();
                buttonToFlash = [...document.querySelectorAll('.btn-operator')].find(
                    btn => btn.textContent === '⌫'
                );
            }

            if (buttonToFlash) {
                buttonToFlash.classList.add('flash');
                setTimeout(() => buttonToFlash.classList.remove('flash'), 100);
            }
        });

        // Initialize display
        updateDisplay();
    </script>
</body>
</html>