<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --pane-bg: #f8f9fa;
            --header-bg: #ffffff;
            --code-bg: #f1f3f5;
            --accent-color: #0366d6;
            --blockquote-color: #6a737d;
            --blockquote-border: #dfe2e5;
        }

        body.dark-mode {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --pane-bg: #161b22;
            --header-bg: #0d1117;
            --code-bg: #21262d;
            --accent-color: #58a6ff;
            --blockquote-color: #8b949e;
            --blockquote-border: #30363d;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s, color 0.2s;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
        }

        h1.title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background-color: var(--pane-bg);
            border-color: var(--blockquote-color);
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0; /* Prevent flex items from overflowing */
        }

        .pane-left {
            border-right: 1px solid var(--border-color);
        }

        textarea#editor {
            flex: 1;
            resize: none;
            border: none;
            padding: 20px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: var(--pane-bg);
            color: var(--text-color);
            outline: none;
        }

        #preview {
            flex: 1;
            padding: 20px 40px;
            overflow-y: auto;
            background-color: var(--bg-color);
            line-height: 1.6;
        }

        /* Markdown Styles for Preview */
        #preview h1, #preview h2, #preview h3 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        #preview h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        #preview h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        #preview h3 { font-size: 1.25em; }
        
        #preview p { margin-top: 0; margin-bottom: 16px; }
        
        #preview ul, #preview ol { padding-left: 2em; margin-bottom: 16px; }
        
        #preview blockquote {
            margin: 0 0 16px;
            padding: 0 1em;
            color: var(--blockquote-color);
            border-left: 0.25em solid var(--blockquote-border);
        }
        
        #preview pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: var(--code-bg);
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        #preview code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: var(--code-bg);
            border-radius: 6px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }
        
        #preview pre code {
            padding: 0;
            background-color: transparent;
        }
        
        #preview a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        #preview a:hover {
            text-decoration: underline;
        }

        #preview img {
            max-width: 100%;
            box-sizing: content-box;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
    </style>
</head>
<body>
    <header>
        <h1 class="title">Markdown Editor</h1>
        <div class="actions">
            <button id="toggle-theme-btn">Dark Mode</button>
            <button id="export-btn">Export HTML</button>
        </div>
    </header>
    <div class="container">
        <div class="pane pane-left">
            <textarea id="editor" placeholder="Type markdown here...
# Hello World
- List item 1
- List item 2

**Bold** and *Italic*
"></textarea>
        </div>
        <div class="pane pane-right">
            <div id="preview"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');
        const exportBtn = document.getElementById('export-btn');

        // Constants
        const STORAGE_KEY_CONTENT = 'md_editor_content';
        const STORAGE_KEY_THEME = 'md_editor_theme_dark';

        // --- Parser Logic ---

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function parseInline(text) {
            // Escape HTML first
            text = escapeHtml(text);

            // Code `...`
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold **...**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Italic *...*
            text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');

            // Links [text](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

            return text;
        }

        function parseMarkdown(markdown) {
            const lines = markdown.split('\n');
            let html = '';
            
            let state = {
                inCodeBlock: false,
                listType: null, // 'ul' or 'ol'
                buffer: [] // Paragraph buffer
            };

            const flushBuffer = () => {
                if (state.buffer.length > 0) {
                    const content = state.buffer.join('\n');
                    html += `<p>${parseInline(content)}</p>\n`;
                    state.buffer = [];
                }
            };

            const closeList = () => {
                if (state.listType) {
                    html += state.listType === 'ul' ? '</ul>\n' : '</ol>\n';
                    state.listType = null;
                }
            };

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const trimmedLine = line.trim();

                // Code Blocks
                if (trimmedLine.startsWith('```')) {
                    flushBuffer();
                    if (state.inCodeBlock) {
                        // End code block
                        html += '</code></pre>\n';
                        state.inCodeBlock = false;
                    } else {
                        // Start code block
                        closeList();
                        html += '<pre><code>';
                        state.inCodeBlock = true;
                    }
                    continue;
                }

                if (state.inCodeBlock) {
                    html += escapeHtml(line) + '\n';
                    continue;
                }

                // Headers
                const headerMatch = line.match(/^(#{1,6})\s+(.*)/);
                if (headerMatch) {
                    flushBuffer();
                    closeList();
                    const level = headerMatch[1].length;
                    html += `<h${level}>${parseInline(headerMatch[2])}</h${level}>\n`;
                    continue;
                }

                // Blockquotes
                if (line.startsWith('>')) {
                    flushBuffer();
                    closeList();
                    // Remove > and whitespace
                    const content = line.replace(/^>\s?/, '');
                    html += `<blockquote>${parseInline(content)}</blockquote>\n`;
                    continue;
                }

                // Lists
                const ulMatch = line.match(/^-\s+(.*)/);
                const olMatch = line.match(/^(\d+)\.\s+(.*)/);

                if (ulMatch) {
                    flushBuffer();
                    if (state.listType !== 'ul') {
                        closeList(); // Close OL if open
                        html += '<ul>\n';
                        state.listType = 'ul';
                    }
                    html += `<li>${parseInline(ulMatch[1])}</li>\n`;
                    continue;
                } 
                
                if (olMatch) {
                    flushBuffer();
                    if (state.listType !== 'ol') {
                        closeList(); // Close UL if open
                        html += '<ol>\n';
                        state.listType = 'ol';
                    }
                    html += `<li>${parseInline(olMatch[2])}</li>\n`;
                    continue;
                }

                // Empty Line
                if (trimmedLine === '') {
                    flushBuffer();
                    closeList();
                    continue;
                }

                // Normal Text (Paragraph)
                closeList(); // If we hit text and we were in a list, standard markdown usually ends list (assuming tight list parsing logic here for simplicity)
                state.buffer.push(line);
            }

            flushBuffer();
            if (state.inCodeBlock) html += '</code></pre>\n';
            closeList();

            return html;
        }

        // --- App Logic ---

        function render() {
            const content = editor.value;
            preview.innerHTML = parseMarkdown(content);
            localStorage.setItem(STORAGE_KEY_CONTENT, content);
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(STORAGE_KEY_THEME, isDark);
            toggleThemeBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }

        function exportHtml() {
            const htmlContent = preview.innerHTML;
            // Get styles
            const styles = document.querySelector('style').innerHTML;
            
            const exportDoc = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exported Document</title>
    <style>
        ${styles}
        body { height: auto; overflow: visible; display: block; max-width: 800px; margin: 0 auto; padding: 20px; }
        #preview { padding: 0; overflow: visible; }
    </style>
</head>
<body class="${document.body.classList.contains('dark-mode') ? 'dark-mode' : ''}">
    <div id="preview">
        ${htmlContent}
    </div>
</body>
</html>`;

            const blob = new Blob([exportDoc], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'markdown-export.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Initialization ---

        function init() {
            // Load Theme
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME);
            if (savedTheme === 'true') {
                document.body.classList.add('dark-mode');
                toggleThemeBtn.textContent = 'Light Mode';
            }

            // Load Content
            const savedContent = localStorage.getItem(STORAGE_KEY_CONTENT);
            if (savedContent !== null) {
                editor.value = savedContent;
            }

            // Initial Render
            render();

            // Bind Events
            editor.addEventListener('input', render);
            toggleThemeBtn.addEventListener('click', toggleTheme);
            exportBtn.addEventListener('click', exportHtml);
        }

        init();

    </script>
</body>
</html>