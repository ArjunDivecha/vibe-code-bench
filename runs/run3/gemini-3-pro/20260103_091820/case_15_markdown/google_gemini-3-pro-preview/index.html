<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown Editor</title>
<style>
    :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --border-color: #cccccc;
        --editor-bg: #f9f9f9;
        --preview-bg: #ffffff;
        --code-bg: #f0f0f0;
        --header-bg: #eeeeee;
        --btn-bg: #e0e0e0;
        --btn-hover: #d0d0d0;
        --blockquote-color: #777;
        --link-color: #0366d6;
    }

    body.dark-mode {
        --bg-color: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #444444;
        --editor-bg: #252526;
        --preview-bg: #1e1e1e;
        --code-bg: #2d2d2d;
        --header-bg: #333333;
        --btn-bg: #333333;
        --btn-hover: #444444;
        --blockquote-color: #aaaaaa;
        --link-color: #58a6ff;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s, color 0.3s;
    }

    header {
        padding: 10px 20px;
        background-color: var(--header-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    h1 {
        margin: 0;
        font-size: 1.2rem;
    }

    .toolbar {
        display: flex;
        gap: 10px;
    }

    button {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        background-color: var(--btn-bg);
        color: var(--text-color);
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: background-color 0.2s;
    }

    button:hover {
        background-color: var(--btn-hover);
    }

    main {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    #editor-container, #preview-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0; /* Fix flexbox overflow issue */
    }

    #editor-container {
        border-right: 1px solid var(--border-color);
    }

    textarea {
        flex: 1;
        width: 100%;
        resize: none;
        border: none;
        padding: 20px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 1rem;
        background-color: var(--editor-bg);
        color: var(--text-color);
        outline: none;
        line-height: 1.5;
    }

    #preview {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: var(--preview-bg);
        line-height: 1.6;
        word-wrap: break-word;
    }

    /* Markdown Preview Styles */
    #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        line-height: 1.25;
        font-weight: 600;
    }
    #preview h1 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; font-size: 2em; }
    #preview h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; font-size: 1.5em; }
    
    #preview p { margin-top: 0; margin-bottom: 16px; }

    #preview code {
        background-color: var(--code-bg);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 85%;
    }

    #preview pre {
        background-color: var(--code-bg);
        padding: 16px;
        border-radius: 6px;
        overflow-x: auto;
        margin-bottom: 16px;
    }
    
    #preview pre code {
        background-color: transparent;
        padding: 0;
        font-size: 100%;
        white-space: pre;
    }

    #preview blockquote {
        border-left: 4px solid var(--border-color);
        margin: 0 0 16px 0;
        padding: 0 1em;
        color: var(--blockquote-color);
    }
    
    #preview ul, #preview ol {
        padding-left: 2em;
        margin-bottom: 16px;
    }

    #preview li {
        margin-bottom: 0.25em;
    }

    #preview img {
        max-width: 100%;
        box-sizing: content-box;
    }
    
    #preview a {
        color: var(--link-color);
        text-decoration: none;
    }
    
    #preview a:hover {
        text-decoration: underline;
    }
    
    #preview hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: var(--border-color);
        border: 0;
    }
</style>
</head>
<body>

<header>
    <h1>Markdown Editor</h1>
    <div class="toolbar">
        <button id="toggle-theme">Dark Mode</button>
        <button id="export-html">Export HTML</button>
    </div>
</header>

<main>
    <div id="editor-container">
        <textarea id="editor" placeholder="Type markdown here..."></textarea>
    </div>
    <div id="preview-container">
        <div id="preview"></div>
    </div>
</main>

<script>
    // Elements
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const toggleThemeBtn = document.getElementById('toggle-theme');
    const exportBtn = document.getElementById('export-html');

    // State
    let isDarkMode = false;

    // --- Markdown Parser ---
    
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function parseMarkdown(text) {
        // 1. Pre-process: Extract code blocks
        const codeBlocks = [];
        let processedText = text.replace(/```([\s\S]*?)```/g, (match, code) => {
            codeBlocks.push(code);
            return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
        });

        // 2. Pre-process: Extract inline code
        const inlineCodeBlocks = [];
        processedText = processedText.replace(/`([^`]+)`/g, (match, code) => {
            inlineCodeBlocks.push(code);
            return `__INLINE_CODE_${inlineCodeBlocks.length - 1}__`;
        });

        // 3. Process Block Elements
        const lines = processedText.split('\n');
        let htmlLines = [];
        let inUl = false;
        let inOl = false;
        let inPara = false;

        const closeList = () => {
            if (inUl) { htmlLines.push('</ul>'); inUl = false; }
            if (inOl) { htmlLines.push('</ol>'); inOl = false; }
        };
        const closePara = () => {
            if (inPara) { htmlLines.push('</p>'); inPara = false; }
        };
        const closeBlocks = () => {
            closeList();
            closePara();
        };

        for (let line of lines) {
            // Headers
            if (/^#{1,6}\s/.test(line)) {
                closeBlocks();
                const level = line.match(/^(#{1,6})/)[0].length;
                const content = line.replace(/^#{1,6}\s+/, '');
                htmlLines.push(`<h${level}>${content}</h${level}>`);
            }
            // Horizontal Rule
            else if (/^---$/.test(line) || /^\*\*\*$/.test(line)) {
                closeBlocks();
                htmlLines.push('<hr>');
            }
            // Blockquote
            else if (/^>\s/.test(line)) {
                closeBlocks();
                // Simple blockquote support (no nested)
                htmlLines.push(`<blockquote>${line.replace(/^>\s+/, '')}</blockquote>`);
            }
            // Unordered List
            else if (/^\s*-\s+/.test(line) || /^\s*\*\s+/.test(line)) {
                closePara();
                if (inOl) { htmlLines.push('</ol>'); inOl = false; }
                if (!inUl) { htmlLines.push('<ul>'); inUl = true; }
                const content = line.replace(/^\s*[-*]\s+/, '');
                htmlLines.push(`<li>${content}</li>`);
            }
            // Ordered List
            else if (/^\s*\d+\.\s+/.test(line)) {
                closePara();
                if (inUl) { htmlLines.push('</ul>'); inUl = false; }
                if (!inOl) { htmlLines.push('<ol>'); inOl = true; }
                const content = line.replace(/^\s*\d+\.\s+/, '');
                htmlLines.push(`<li>${content}</li>`);
            }
            // Empty Line
            else if (/^\s*$/.test(line)) {
                closeBlocks();
            }
            // Paragraph / Text
            else {
                closeList();
                if (!inPara) { 
                    htmlLines.push('<p>'); 
                    inPara = true; 
                    htmlLines.push(line);
                } else {
                    htmlLines.push(' ' + line);
                }
            }
        }
        closeBlocks();

        let html = htmlLines.join('\n');

        // 4. Process Inline Elements (Bold, Italic, Link, Image)
        // Images
        html = html.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">');
        // Links
        html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
        // Bold
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
        // Italic
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        html = html.replace(/_(.*?)_/g, '<em>$1</em>');

        // 5. Restore Code Blocks
        html = html.replace(/__INLINE_CODE_(\d+)__/g, (match, id) => {
            return `<code>${escapeHtml(inlineCodeBlocks[id])}</code>`;
        });

        html = html.replace(/__CODE_BLOCK_(\d+)__/g, (match, id) => {
            return `<pre><code>${escapeHtml(codeBlocks[id])}</code></pre>`;
        });

        return html;
    }

    // --- App Logic ---

    function updatePreview() {
        const markdown = editor.value;
        const html = parseMarkdown(markdown);
        preview.innerHTML = html;
        try {
            localStorage.setItem('markdown-content', markdown);
        } catch (e) { console.error('LocalStorage unavailable'); }
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            toggleThemeBtn.textContent = 'Light Mode';
        } else {
            document.body.classList.remove('dark-mode');
            toggleThemeBtn.textContent = 'Dark Mode';
        }
        try {
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        } catch (e) {}
    }

    function loadState() {
        let savedContent = null;
        let savedTheme = null;
        
        try {
            savedContent = localStorage.getItem('markdown-content');
            savedTheme = localStorage.getItem('theme');
        } catch (e) {}

        if (savedContent !== null) {
            editor.value = savedContent;
        } else {
            // Default content
            editor.value = "# Welcome to Markdown Editor\n\nType on the left, see preview on the right.\n\n## Features\n- **Bold** and *Italic* text\n- Lists (ordered and unordered)\n- [Links](https://example.com)\n- Blockquotes\n\n> This is a blockquote.\n\n### Code Blocks\n\n```\nfunction hello() {\n  console.log('Hello World!');\n}\n```\n\nEnjoy writing!";
        }
        updatePreview();

        if (savedTheme === 'dark') {
            toggleTheme(); // Sets it to dark
        }
    }

    function exportHtml() {
        const htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Exported Markdown</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
code { background: #f4f4f4; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
pre { background: #f4f4f4; padding: 16px; overflow-x: auto; border-radius: 6px; }
pre code { background: none; padding: 0; }
blockquote { border-left: 4px solid #ccc; margin: 0 0 16px 0; padding-left: 1em; color: #777; }
img { max-width: 100%; }
a { color: #0366d6; text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;
        
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'markdown-export.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Event Listeners
    editor.addEventListener('input', updatePreview);
    toggleThemeBtn.addEventListener('click', toggleTheme);
    exportBtn.addEventListener('click', exportHtml);

    // Init
    loadState();

</script>
</body>
</html>