<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analytics Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #2c3e50; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .full-width { grid-column: span 2; }
        
        svg { width: 100%; height: 300px; overflow: visible; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: white; }

        .table-container { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background-color: #f8f9fa; position: sticky; top: 0; }
        tr:hover { background-color: #f1f1f1; }
        
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 12px; display: inline-block; width: 60px; text-align: center; }
        .bg-INFO { background-color: #2ecc71; }
        .bg-WARN { background-color: #f1c40f; color: #333; }
        .bg-ERROR { background-color: #e74c3c; }
        .bg-CRITICAL { background-color: #8e44ad; }

        .bar { fill: #3498db; transition: fill 0.2s; }
        .bar:hover { fill: #2980b9; }
        .axis-text { font-size: 10px; fill: #7f8c8d; }
        .pie-slice { transition: opacity 0.2s; cursor: pointer; stroke: #fff; stroke-width: 2px; }
        .pie-slice:hover { opacity: 0.8; }
        
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; pointer-events: none; font-size: 12px; display: none; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .error-list { list-style: none; padding: 0; }
        .error-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .error-list li:last-child { border-bottom: none; }
        .count-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;}
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Log Analytics Dashboard</h1>
        
        <div class="grid">
            <div class="card">
                <h2>Log Level Distribution</h2>
                <svg id="pieChart" viewBox="-100 -100 200 200"></svg>
            </div>
            <div class="card">
                <h2>Errors per Hour</h2>
                <svg id="barChart"></svg>
            </div>
        </div>

        <div class="card full-width">
            <h2>Common Error Messages</h2>
            <ul id="topErrorsList" class="error-list"></ul>
        </div>

        <div class="card full-width">
            <h2>Log Viewer</h2>
            <div class="controls">
                <input type="text" id="searchInput" class="search-box" placeholder="Search logs...">
                <select id="levelFilter" class="filter-select">
                    <option value="ALL">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL" selected>CRITICAL</option>
                </select>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th width="180">Timestamp</th>
                            <th width="100">Level</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>

    <script>
        const colors = {
            'INFO': '#2ecc71',
            'WARN': '#f1c40f',
            'ERROR': '#e74c3c',
            'CRITICAL': '#8e44ad'
        };

        let allLogs = [];

        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                allLogs = data.all_logs;
                
                renderPieChart(data.level_counts);
                renderBarChart(data.errors_per_hour);
                renderTopErrors(data.top_errors);
                
                document.getElementById('levelFilter').value = 'CRITICAL';
                filterAndRenderTable();
                
            } catch (e) {
                console.error("Failed to fetch data", e);
                document.querySelector('.container').innerHTML = `<h1>Error loading data</h1><p>Ensure Python server is running.</p>`;
            }
        }

        function renderTopErrors(errors) {
            const list = document.getElementById('topErrorsList');
            list.innerHTML = '';
            errors.forEach(([msg, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${msg}</span> <span class="count-badge">${count}</span>`;
                list.appendChild(li);
            });
            if (errors.length === 0) list.innerHTML = '<li>No errors found</li>';
        }

        function renderPieChart(counts) {
            const svg = document.getElementById('pieChart');
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let startAngle = 0;
            svg.innerHTML = '';
            const levels = ['INFO', 'WARN', 'ERROR', 'CRITICAL'];

            for (const level of levels) {
                const count = counts[level] || 0;
                if (count === 0) continue;
                
                const sliceAngle = (count / total) * 2 * Math.PI;
                const endAngle = startAngle + sliceAngle;
                const x1 = Math.cos(startAngle) * 80;
                const y1 = Math.sin(startAngle) * 80;
                const x2 = Math.cos(endAngle) * 80;
                const y2 = Math.sin(endAngle) * 80;
                const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;

                let d = '';
                if (count === total) {
                    d = `M 0 0 m -80 0 a 80 80 0 1 0 160 0 a 80 80 0 1 0 -160 0`;
                } else {
                    d = [`M 0 0`, `L ${x1} ${y1}`, `A 80 80 0 ${largeArcFlag} 1 ${x2} ${y2}`, `Z`].join(' ');
                }

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('fill', colors[level]);
                path.setAttribute('class', 'pie-slice');
                path.addEventListener('mousemove', (e) => showTooltip(e, `${level}: ${count} (${(count/total*100).toFixed(1)}%)`));
                path.addEventListener('mouseleave', hideTooltip);
                svg.appendChild(path);
                startAngle = endAngle;
            }
        }

        function renderBarChart(timeline) {
            const svg = document.getElementById('barChart');
            svg.innerHTML = '';
            const entries = Object.entries(timeline).sort();
            if (entries.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '50%');
                text.setAttribute('y', '50%');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = "No errors recorded";
                svg.appendChild(text);
                return;
            }

            const values = entries.map(e => e[1]);
            const maxVal = Math.max(...values);
            const count = entries.length;
            const width = svg.clientWidth || 600;
            const height = svg.clientHeight || 300;
            const padding = 30;
            const chartW = width - 2 * padding;
            const chartH = height - 2 * padding;
            const barWidth = (chartW / count) * 0.8;
            const gap = (chartW / count) * 0.2;

            entries.forEach((entry, i) => {
                const [time, val] = entry;
                const barHeight = (val / maxVal) * chartH;
                const x = padding + i * (barWidth + gap);
                const y = height - padding - barHeight;

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('class', 'bar');
                if (val > 5) rect.style.fill = '#c0392b';
                
                rect.addEventListener('mousemove', (e) => showTooltip(e, `${time}: ${val} Errors`));
                rect.addEventListener('mouseleave', hideTooltip);
                svg.appendChild(rect);

                if (count < 15 || i % Math.ceil(count/10) === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x + barWidth/2);
                    text.setAttribute('y', height - padding + 15);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('class', 'axis-text');
                    text.textContent = time.split(' ')[1] + 'h';
                    svg.appendChild(text);
                }
            });
        }

        function filterAndRenderTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const filtered = allLogs.filter(log => {
                const matchesSearch = log.message.toLowerCase().includes(search) || log.timestamp.includes(search);
                const matchesLevel = level === 'ALL' || log.level === level;
                return matchesSearch && matchesLevel;
            });

            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            const displayLogs = filtered.slice(0, 500); 

            displayLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family: monospace; color: #666;">${log.timestamp}</td>
                    <td><span class="badge bg-${log.level}">${log.level}</span></td>
                    <td>${log.message}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No logs found</td></tr>';
            }
        }

        document.getElementById('searchInput').addEventListener('input', filterAndRenderTable);
        document.getElementById('levelFilter').addEventListener('change', filterAndRenderTable);

        const tooltip = document.getElementById('tooltip');
        function showTooltip(e, text) {
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY + 10) + 'px';
            tooltip.textContent = text;
        }
        function hideTooltip() { tooltip.style.display = 'none'; }
        fetchData();
    </script>
</body>
</html>