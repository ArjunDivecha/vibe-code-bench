<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Log Analytics Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { text-align: center; }
section { margin: 20px 0; }
#charts svg { width: 100%; height: 300px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
input[type="text"] { width: 100%; padding: 6px; margin-bottom: 10px; }
button { margin-right: 10px; padding: 5px 10px; }
</style>
</head>
<body>
<h1>Log Analytics Dashboard</h1>

<section id="percentages">
  <h2>Log Level Percentages</h2>
  <div id="level-bars"></div>
</section>

<section id="charts">
  <h2>Errors Per Hour</h2>
  <svg id="error-chart"></svg>
</section>

<section id="common-errors">
  <h2>Top 10 Common Error Messages</h2>
  <ul id="error-list"></ul>
</section>

<section id="critical-errors">
  <h2>CRITICAL Errors</h2>
  <input type="text" id="search" placeholder="Search messages...">
  <table>
    <thead>
      <tr><th>Timestamp</th><th>Message</th></tr>
    </thead>
    <tbody id="critical-table"></tbody>
  </table>
</section>

<script>
async function loadData() {
  const res = await fetch('/data');
  const data = await res.json();
  renderPercentages(data.level_percentages);
  renderErrorChart(data.errors_per_hour);
  renderCommonErrors(data.common_errors);
  renderCriticalTable(data.critical_entries);
}

function renderPercentages(levels) {
  const container = document.getElementById('level-bars');
  container.innerHTML = '';
  for (let level in levels) {
    const div = document.createElement('div');
    div.style.margin = '5px 0';
    div.innerHTML = level + ': ' + levels[level] + '%';
    const bar = document.createElement('div');
    bar.style.height = '10px';
    bar.style.width = levels[level] + '%';
    bar.style.background = levelColor(level);
    container.appendChild(div);
    container.appendChild(bar);
  }
}

function levelColor(level) {
  return {
    'INFO': 'green',
    'WARN': 'orange',
    'ERROR': 'red',
    'CRITICAL': 'darkred'
  }[level] || 'gray';
}

function renderErrorChart(data) {
  const svg = document.getElementById('error-chart');
  svg.innerHTML = '';
  const keys = Object.keys(data);
  const values = Object.values(data);
  if (keys.length === 0) return;

  const max = Math.max(...values);
  const width = svg.clientWidth;
  const height = svg.clientHeight;
  const barWidth = width / keys.length;

  keys.forEach((key, i) => {
    const val = data[key];
    const barHeight = (val / max) * (height - 20);
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute('x', i * barWidth);
    rect.setAttribute('y', height - barHeight);
    rect.setAttribute('width', barWidth - 2);
    rect.setAttribute('height', barHeight);
    rect.setAttribute('fill', 'steelblue');
    svg.appendChild(rect);
  });
}

function renderCommonErrors(errors) {
  const ul = document.getElementById('error-list');
  ul.innerHTML = '';
  errors.forEach(([msg, count]) => {
    const li = document.createElement('li');
    li.textContent = `${msg} (${count})`;
    ul.appendChild(li);
  });
}

function renderCriticalTable(entries) {
  const tbody = document.getElementById('critical-table');
  tbody.innerHTML = '';
  entries.forEach(e => {
    const tr = document.createElement('tr');
    const td1 = document.createElement('td');
    td1.textContent = e.timestamp;
    const td2 = document.createElement('td');
    td2.textContent = e.message;
    tr.appendChild(td1);
    tr.appendChild(td2);
    tbody.appendChild(tr);
  });

  document.getElementById('search').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    Array.from(tbody.children).forEach(row => {
      const msg = row.children[1].textContent.toLowerCase();
      row.style.display = msg.includes(filter) ? '' : 'none';
    });
  });
}

loadData();
</script>
</body>
</html>