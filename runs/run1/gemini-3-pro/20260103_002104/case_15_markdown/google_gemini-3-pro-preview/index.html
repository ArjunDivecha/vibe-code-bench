<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --pane-bg: #ffffff;
            --input-bg: #fdfdfd;
            --header-bg: #f0f0f0;
            --code-bg: #f4f4f4;
            --blockquote-color: #666;
            --blockquote-border: #ddd;
            --link-color: #0366d6;
        }

        body.dark-mode {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --pane-bg: #1e1e1e;
            --input-bg: #252526;
            --header-bg: #2d2d2d;
            --code-bg: #2d2d2d;
            --blockquote-color: #aaa;
            --blockquote-border: #555;
            --link-color: #58a6ff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            background-color: var(--header-bg);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .controls button {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .controls button:hover {
            filter: brightness(0.9);
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0; /* Prevent flex item from overflowing */
        }

        .pane:first-child {
            border-right: 1px solid var(--border-color);
        }

        textarea {
            flex: 1;
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            padding: 1.5rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
        }

        #preview {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: var(--pane-bg);
        }

        /* Rendered Markdown Styles */
        #preview h1, #preview h2, #preview h3 { 
            margin-top: 1.5em; 
            margin-bottom: 0.5em; 
            line-height: 1.2;
        }
        #preview h1:first-child, #preview h2:first-child, #preview h3:first-child { 
            margin-top: 0; 
        }
        #preview p { 
            margin-bottom: 1em; 
            line-height: 1.6; 
        }
        #preview ul, #preview ol { 
            margin-bottom: 1em; 
            padding-left: 2em; 
        }
        #preview li {
            margin-bottom: 0.25em;
        }
        #preview blockquote {
            border-left: 4px solid var(--blockquote-border);
            margin: 0 0 1em 0;
            padding: 0.5em 1em;
            color: var(--blockquote-color);
            background-color: rgba(128,128,128,0.05);
        }
        #preview pre {
            background-color: var(--code-bg);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid var(--border-color);
        }
        #preview code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: rgba(128,128,128,0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        #preview pre code {
            padding: 0;
            background-color: transparent;
            font-size: 1em;
        }
        #preview a { 
            color: var(--link-color); 
            text-decoration: none; 
        }
        #preview a:hover { 
            text-decoration: underline; 
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .pane:first-child {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>MD Editor</h1>
        <div class="controls">
            <button id="theme-toggle">Dark Mode</button>
            <button id="export-btn">Export HTML</button>
        </div>
    </header>
    <div class="container">
        <div class="pane">
            <textarea id="editor" placeholder="# Welcome to Markdown Editor&#10;&#10;Start typing your markdown here..."></textarea>
        </div>
        <div class="pane">
            <div id="preview"></div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const themeToggle = document.getElementById('theme-toggle');
        const exportBtn = document.getElementById('export-btn');

        // State
        let isDarkMode = false;

        // --- Markdown Parser ---

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatInline(text) {
            // Escape HTML first to prevent XSS in rendered output
            let output = escapeHtml(text);

            // Bold: **text**
            output = output.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic: *text*
            output = output.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Links: [text](url)
            output = output.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Inline Code: `text` (simple handling)
            output = output.replace(/`([^`]+)`/g, '<code>$1</code>');

            return output;
        }

        function parseMarkdown(markdown) {
            const lines = markdown.split('\n');
            let html = '';
            let state = 'NORMAL'; // NORMAL, CODE, UL, OL, P, BLOCKQUOTE

            const closeState = (newState) => {
                if (state === 'UL' && newState !== 'UL') html += '</ul>\n';
                if (state === 'OL' && newState !== 'OL') html += '</ol>\n';
                if (state === 'P' && newState !== 'P') html += '</p>\n';
                if (state === 'BLOCKQUOTE' && newState !== 'BLOCKQUOTE') html += '</blockquote>\n';
            };

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const trimmed = line.trim();

                // Code Blocks
                if (trimmed.startsWith('```')) {
                    if (state === 'CODE') {
                        html += '</code></pre>\n';
                        state = 'NORMAL';
                    } else {
                        closeState('CODE');
                        html += '<pre><code>';
                        state = 'CODE';
                    }
                    continue;
                }

                if (state === 'CODE') {
                    html += escapeHtml(line) + '\n';
                    continue;
                }

                // Headers
                if (line.startsWith('#')) {
                    const match = line.match(/^(#{1,6})\s+(.*)$/);
                    if (match) {
                        closeState('NORMAL');
                        const level = match[1].length;
                        html += `<h${level}>${formatInline(match[2])}</h${level}>\n`;
                        continue;
                    }
                }

                // Lists (Unordered)
                if (line.match(/^\s*-\s+/)) {
                    if (state !== 'UL') {
                        closeState('UL');
                        html += '<ul>\n';
                        state = 'UL';
                    }
                    const content = line.replace(/^\s*-\s+/, '');
                    html += `<li>${formatInline(content)}</li>\n`;
                    continue;
                }

                // Lists (Ordered)
                if (line.match(/^\s*\d+\.\s+/)) {
                    if (state !== 'OL') {
                        closeState('OL');
                        html += '<ol>\n';
                        state = 'OL';
                    }
                    const content = line.replace(/^\s*\d+\.\s+/, '');
                    html += `<li>${formatInline(content)}</li>\n`;
                    continue;
                }

                // Blockquotes
                if (line.startsWith('>')) {
                    if (state !== 'BLOCKQUOTE') {
                        closeState('BLOCKQUOTE');
                        html += '<blockquote>\n';
                        state = 'BLOCKQUOTE';
                    }
                    const content = line.replace(/^>\s?/, '');
                    html += `${formatInline(content)}<br>\n`;
                    continue;
                }

                // Empty lines
                if (trimmed === '') {
                    closeState('NORMAL');
                    continue;
                }

                // Paragraphs
                if (state !== 'P') {
                    closeState('P');
                    html += '<p>';
                    state = 'P';
                } else {
                    html += ' ';
                }
                html += formatInline(line);
            }

            closeState('NORMAL');
            return html;
        }

        // --- UI Logic ---

        function render() {
            const markdown = editor.value;
            const html = parseMarkdown(markdown);
            preview.innerHTML = html;
            localStorage.setItem('markdown-content', markdown);
        }

        // --- Event Listeners ---

        editor.addEventListener('input', render);

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('dark-mode', isDarkMode);
        });

        exportBtn.addEventListener('click', () => {
            const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Markdown Export</title>
<style>
body { font-family: sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 2rem; color: #333; }
pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; border-radius: 4px; }
blockquote { border-left: 4px solid #ddd; padding-left: 1rem; color: #666; }
code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
</style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- Initialization ---

        window.addEventListener('DOMContentLoaded', () => {
            // Load Content
            const savedContent = localStorage.getItem('markdown-content');
            if (savedContent !== null) {
                editor.value = savedContent;
            } else {
                // Default content
                editor.value = "# Hello World\n\nThis is a **markdown editor**.\n\n- It supports lists\n- And *italics*\n\n1. Ordered lists too\n2. Like this\n\n> And blockquotes!\n\n```\n// And code blocks\nconsole.log('Hello');\n```\n\n[Link to Google](https://google.com)";
            }

            // Load Theme
            const savedTheme = localStorage.getItem('dark-mode');
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
            }

            render();
        });

    </script>
</body>
</html>