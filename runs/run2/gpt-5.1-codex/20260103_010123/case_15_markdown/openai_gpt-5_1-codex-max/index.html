<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Markdown Editor</title>
<style>
  :root {
    --bg: #f5f5f5;
    --panel: #ffffff;
    --text: #1e1e1e;
    --muted: #666;
    --border: #dddddd;
    --accent: #007acc;
    --code-bg: #f0f0f0;
  }
  body.dark {
    --bg: #1c1f26;
    --panel: #242834;
    --text: #e0e3eb;
    --muted: #9aa2b5;
    --border: #303646;
    --accent: #4dabf7;
    --code-bg: #1a1f2b;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    flex: 1;
  }
  .btn {
    background: var(--accent);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.1s ease, box-shadow 0.1s ease;
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .status {
    color: var(--muted);
    font-size: 13px;
    min-width: 120px;
  }
  main {
    flex: 1;
    display: flex;
    gap: 10px;
    padding: 10px;
    overflow: hidden;
  }
  .pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .pane h2 {
    margin: 0;
    padding: 10px 12px;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    letter-spacing: 0.02em;
    color: var(--muted);
  }
  textarea {
    flex: 1;
    border: none;
    outline: none;
    resize: none;
    width: 100%;
    padding: 14px;
    background: var(--panel);
    color: var(--text);
    font-size: 15px;
    font-family: "Fira Code", "SFMono-Regular", Consolas, monospace;
  }
  #preview {
    flex: 1;
    overflow: auto;
    padding: 14px;
    background: var(--panel);
  }
  #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
    margin-top: 18px;
    margin-bottom: 10px;
    line-height: 1.2;
  }
  #preview p { margin: 10px 0; line-height: 1.6; }
  #preview ul, #preview ol { padding-left: 22px; margin: 8px 0 12px 0; }
  #preview li { margin: 4px 0; }
  #preview a { color: var(--accent); text-decoration: none; }
  #preview a:hover { text-decoration: underline; }
  #preview blockquote {
    border-left: 4px solid var(--accent);
    margin: 10px 0;
    padding: 8px 12px;
    background: rgba(0,0,0,0.03);
    color: var(--muted);
  }
  #preview code {
    background: var(--code-bg);
    padding: 2px 4px;
    border-radius: 4px;
    font-family: "Fira Code", "SFMono-Regular", Consolas, monospace;
    font-size: 90%;
  }
  #preview pre {
    background: var(--code-bg);
    padding: 12px;
    border-radius: 8px;
    overflow: auto;
  }
  #preview pre code { padding: 0; background: transparent; display: block; }
  .toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    cursor: pointer;
    background: transparent;
    color: var(--text);
  }
</style>
</head>
<body>
<header>
  <h1>Markdown Editor</h1>
  <div class="status" id="status"></div>
  <button class="btn secondary" id="load">Load</button>
  <button class="btn secondary" id="save">Save</button>
  <button class="btn secondary" id="export">Export HTML</button>
  <button class="toggle" id="darkToggle">üåô Dark Mode</button>
</header>

<main>
  <div class="pane">
    <h2>Markdown</h2>
    <textarea id="editor" spellcheck="false"></textarea>
  </div>
  <div class="pane">
    <h2>Preview</h2>
    <div id="preview"></div>
  </div>
</main>

<script>
(function() {
  const textarea = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const saveBtn = document.getElementById('save');
  const loadBtn = document.getElementById('load');
  const exportBtn = document.getElementById('export');
  const darkToggle = document.getElementById('darkToggle');
  const statusEl = document.getElementById('status');
  const STORAGE_KEY = 'markdown-editor-content';
  const THEME_KEY = 'markdown-editor-theme';

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
  }

  function parseMarkdown(markdown) {
    const codeBlocks = [];
    const placeholder = '\uE000';

    markdown = markdown.replace(/\r\n/g, '\n');
    markdown = markdown.replace(/```([\s\S]*?)```/g, function(_, code) {
      codeBlocks.push(code);
      return `${placeholder}${codeBlocks.length - 1}${placeholder}`;
    });

    const lines = markdown.split('\n');
    let html = '';
    let inUl = false;
    let inOl = false;
    let inBlockquote = false;

    function closeLists() {
      if (inUl) { html += '</ul>'; inUl = false; }
      if (inOl) { html += '</ol>'; inOl = false; }
    }
    function closeBlockquote() {
      if (inBlockquote) { html += '</blockquote>'; inBlockquote = false; }
    }

    function formatInline(text) {
      text = escapeHtml(text);
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
      text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      return text;
    }

    for (let line of lines) {
      const trimmed = line.trim();
      const codeMatch = line.match(new RegExp(placeholder + '(\\d+)' + placeholder));
      if (trimmed === '') {
        closeLists();
        if (inBlockquote) { html += '<br>'; }
        continue;
      }

      if (codeMatch && trimmed === `${placeholder}${codeMatch[1]}${placeholder}`) {
        closeLists(); closeBlockquote();
        const codeContent = escapeHtml(codeBlocks[parseInt(codeMatch[1], 10)]);
        html += `<pre><code>${codeContent}</code></pre>`;
        continue;
      }

      const blockquoteMatch = line.match(/^\s*>\s?(.*)$/);
      const headerMatch = line.match(/^(#{1,6})\s+(.*)$/);
      const listMatch = line.match(/^\s*[-*]\s+(.+)$/);
      const olMatch = line.match(/^\s*\d+\.\s+(.+)$/);

      if (blockquoteMatch) {
        if (!inBlockquote) { closeLists(); html += '<blockquote>'; inBlockquote = true; }
        const content = blockquoteMatch[1];
        const innerHeader = content.match(/^(#{1,6})\s+(.*)$/);
        if (innerHeader) {
          html += `<h${innerHeader[1].length}>${formatInline(innerHeader[2])}</h${innerHeader[1].length}>`;
        } else {
          html += `<p>${formatInline(content)}</p>`;
        }
        continue;
      } else if (inBlockquote) {
        closeBlockquote();
      }

      if (headerMatch) {
        closeLists();
        html += `<h${headerMatch[1].length}>${formatInline(headerMatch[2])}</h${headerMatch[1].length}>`;
        continue;
      }

      if (listMatch) {
        if (!inUl) { closeLists(); html += '<ul>'; inUl = true; }
        html += `<li>${formatInline(listMatch[1])}</li>`;
        continue;
      }

      if (olMatch) {
        if (!inOl) { closeLists(); html += '<ol>'; inOl = true; }
        html += `<li>${formatInline(olMatch[1])}</li>`;
        continue;
      }

      closeLists();
      html += `<p>${formatInline(line)}</p>`;
    }

    closeLists();
    closeBlockquote();

    html = html.replace(new RegExp(placeholder + '(\\d+)' + placeholder, 'g'), function(_, idx) {
      return `<pre><code>${escapeHtml(codeBlocks[Number(idx)])}</code></pre>`;
    });

    return html;
  }

  function render() {
    const md = textarea.value;
    preview.innerHTML = parseMarkdown(md);
  }

  function saveContent() {
    localStorage.setItem(STORAGE_KEY, textarea.value);
    flashStatus('Saved');
  }

  function loadContent() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved !== null) {
      textarea.value = saved;
      render();
      flashStatus('Loaded saved content');
    } else {
      flashStatus('No saved content', true);
    }
  }

  function flashStatus(msg, muted=false) {
    statusEl.textContent = msg;
    statusEl.style.color = muted ? 'var(--muted)' : 'var(--accent)';
    setTimeout(() => { statusEl.textContent = ''; }, 1600);
  }

  function toggleTheme(init=false) {
    const current = document.body.classList.contains('dark');
    const next = init ? current : !current;
    document.body.classList.toggle('dark', next);
    localStorage.setItem(THEME_KEY, next ? 'dark' : 'light');
    darkToggle.textContent = next ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  }

  function exportHtml() {
    const content = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Exported Markdown</title>
<style>
  body { font-family: "Segoe UI", sans-serif; padding: 30px; line-height: 1.6; background: #fdfdfd; color: #1e1e1e; }
  h1,h2,h3,h4,h5,h6 { margin-top: 18px; margin-bottom: 10px; }
  p { margin: 10px 0; }
  ul, ol { padding-left: 22px; }
  blockquote { border-left: 4px solid #007acc; padding: 8px 12px; margin: 10px 0; background: #f3f7ff; color: #555; }
  code { background: #f0f0f0; padding: 2px 4px; border-radius: 4px; font-family: "Fira Code", monospace; }
  pre { background: #f0f0f0; padding: 12px; border-radius: 8px; overflow: auto; }
</style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;
    const blob = new Blob([content], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'markdown.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function init() {
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme === 'dark') document.body.classList.add('dark');
    toggleTheme(true);

    const saved = localStorage.getItem(STORAGE_KEY);
    textarea.value = saved ?? `# Welcome to the Markdown Editor

Start typing on the left, see preview on the right. Features supported:
- Headers (#, ##, ###)
- **Bold** and *italic*
- Lists, links, code blocks, and blockquotes

> ‚ÄúWrite your docs in style!‚Äù

\`\`\`
function greet(name) {
  return "Hello " + name;
}
\`\`\`

[OpenAI](https://openai.com)`;
    render();
  }

  textarea.addEventListener('input', () => { render(); localStorage.setItem(STORAGE_KEY, textarea.value); });
  saveBtn.addEventListener('click', saveContent);
  loadBtn.addEventListener('click', loadContent);
  exportBtn.addEventListener('click', exportHtml);
  darkToggle.addEventListener('click', () => toggleTheme());

  init();
})();
</script>
</body>
</html>